# Data Model: REQ-005 - Command Emitter

**Generated from**: TECH_DESIGN.md Section 3
**Type**: Intermediate Representation (IR) - Not Database

---

## 1. Command IR Schema

Command Emitter 使用内存中的数据结构，不涉及数据库存储。

### 1.1 CommandIR

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| source.path | string | Yes | 源文件绝对路径 |
| source.filename | string | Yes | 文件名 (不含扩展名) |
| source.hash | string | Yes | SHA-256 内容哈希 |
| frontmatter.name | string | Yes | 命令名称 |
| frontmatter.description | string | Yes | 命令描述 |
| frontmatter.scripts | Map<string, string> | No | alias -> 脚本路径映射 |
| frontmatter.agent_scripts | AgentScripts | No | shell 类型 -> 脚本内容映射 |
| body | string | Yes | Markdown 正文内容 |
| placeholders | Placeholder[] | Yes | 检测到的占位符列表 |

### 1.2 AgentScripts

| Field | Type | Description |
|-------|------|-------------|
| sh | string | Bash 脚本内容 |
| ps | string | PowerShell 脚本内容 (可选) |

### 1.3 Placeholder

| Field | Type | Description |
|-------|------|-------------|
| type | enum | "SCRIPT" \| "AGENT_SCRIPT" \| "ARGUMENTS" |
| raw | string | 原始占位符文本 |
| alias | string? | script alias (仅 SCRIPT 类型) |
| position | { start, end } | 占位符在 body 中的位置 |

---

## 2. Manifest Schema

### 2.1 Manifest Entry

| Field | Type | Description |
|-------|------|-------------|
| source | string | 源文件相对路径 |
| target | string | 目标文件相对路径 |
| hash | string | 源文件 SHA-256 哈希 |
| timestamp | string | ISO 8601 编译时间戳 |
| platform | enum | "codex" \| "cursor" \| "qwen" \| "antigravity" |

### 2.2 Manifest File

```json
{
  "version": "1.0.0",
  "generatedAt": "2025-12-18T10:00:00Z",
  "entries": [
    {
      "source": ".claude/commands/flow-prd.md",
      "target": ".codex/prompts/flow-prd.md",
      "hash": "sha256:abc123...",
      "timestamp": "2025-12-18T10:00:00Z",
      "platform": "codex"
    }
  ]
}
```

---

## 3. Platform Output Formats

### 3.1 Codex Output

**格式**: Markdown + YAML frontmatter
**目录**: `.codex/prompts/`

```yaml
---
description: Generate PRD document
argument-hint: [REQ_ID=<id>]
---
# Flow-PRD Command
...
```

### 3.2 Cursor Output

**格式**: 纯 Markdown (无 frontmatter)
**目录**: `.cursor/commands/`

```markdown
# Flow-PRD Command
...
```

### 3.3 Qwen Output

**格式**: TOML
**目录**: `.qwen/commands/`

```toml
description = "Generate PRD document"
prompt = """
# Flow-PRD Command
...
"""
```

### 3.4 Antigravity Output

**格式**: Markdown + YAML frontmatter (必需)
**目录**: `.agent/workflows/`
**限制**: 单文件 <= 12,000 字符

```yaml
---
description: Generate PRD document
---
# Flow-PRD Command
...
```

---

## 4. Zod Schemas (Runtime Validation)

```javascript
// lib/compiler/schemas.js
import { z } from 'zod';

export const PlaceholderSchema = z.object({
  type: z.enum(['SCRIPT', 'AGENT_SCRIPT', 'ARGUMENTS']),
  raw: z.string(),
  alias: z.string().optional(),
  position: z.object({
    start: z.number(),
    end: z.number(),
  }),
});

export const FrontmatterSchema = z.object({
  name: z.string().min(1),
  description: z.string().min(1),
  scripts: z.record(z.string()).optional(),
  agent_scripts: z.object({
    sh: z.string().optional(),
    ps: z.string().optional(),
  }).optional(),
});

export const CommandIRSchema = z.object({
  source: z.object({
    path: z.string(),
    filename: z.string(),
    hash: z.string(),
  }),
  frontmatter: FrontmatterSchema,
  body: z.string(),
  placeholders: z.array(PlaceholderSchema),
});

export const ManifestEntrySchema = z.object({
  source: z.string(),
  target: z.string(),
  hash: z.string(),
  timestamp: z.string().datetime(),
  platform: z.enum(['codex', 'cursor', 'qwen', 'antigravity']),
});

export const ManifestSchema = z.object({
  version: z.string(),
  generatedAt: z.string().datetime(),
  entries: z.array(ManifestEntrySchema),
});
```

---

**Generated by**: /flow-tech
**Template Version**: 1.0.0
