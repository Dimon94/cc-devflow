# CC-DevFlow 质量闸原则

> **基于**: CC-DevFlow 项目宪法
> **适用范围**: 所有开发流程和代码提交
> **强制性**: 不可跳过

---

## 🚪 质量闸概述

质量闸是确保代码质量的**强制检查点**，基于项目宪法的"质量至上"原则建立。任何代码变更都必须通过所有适用的质量闸才能被接受。

### 质量闸哲学
- **预防优于治疗**: 在问题进入代码库前拦截
- **自动化优先**: 减少人为错误和主观判断
- **零容忍**: 对质量问题零容忍
- **持续改进**: 质量标准只能提高，不能降低

---

## 🎯 质量闸分类

### 1. 基础质量闸 (必须)
**触发时机**: 每次代码提交前
**检查范围**: 所有变更文件

#### 1.1 语法和类型检查
```yaml
TypeScript检查:
  - 严格模式: 启用
  - 类型覆盖: 100%
  - 编译错误: 0个
  - 类型警告: 0个

Python检查:
  - mypy: 通过
  - flake8: 通过
  - black格式: 通过
```

#### 1.2 代码质量检查
```yaml
Linting规则:
  - ESLint/Pylint: 通过
  - 代码风格: 一致
  - 复杂度: 符合标准
  - 重复代码: 无
```

#### 1.3 安全基础检查
```yaml
安全扫描:
  - 硬编码密钥: 无
  - SQL注入风险: 无
  - XSS风险: 无
  - 敏感文件: 无
```

---

### 2. 功能质量闸 (必须)
**触发时机**: 新功能实现后
**检查范围**: 新增和修改的功能

#### 2.1 测试覆盖率
```yaml
测试要求:
  最小覆盖率: 80%
  单元测试: 必须
  集成测试: 核心流程必须
  边缘情况: 覆盖

覆盖率计算:
  行覆盖率: ≥80%
  分支覆盖率: ≥75%
  函数覆盖率: ≥90%
```

#### 2.2 功能完整性
```yaml
实现标准:
  - 功能完整: 100%
  - 错误处理: 完善
  - 边缘情况: 处理
  - 性能要求: 满足
```

---

### 3. 架构质量闸 (必须)
**触发时机**: 架构性变更时
**检查范围**: 系统架构和设计

#### 3.1 依赖管理
```yaml
依赖检查:
  - 新依赖评估: 通过
  - 版本兼容: 确认
  - 安全漏洞: 无
  - 许可证合规: 通过
```

#### 3.2 架构一致性
```yaml
架构原则:
  - 分层清晰: 是
  - 职责单一: 是
  - 接口设计: 合理
  - 扩展性: 良好
```

---

### 4. 性能质量闸 (核心功能必须)
**触发时机**: 性能关键代码变更
**检查范围**: 性能敏感组件

#### 4.1 性能基准
```yaml
性能要求:
  响应时间: <100ms (关键路径)
  吞吐量: 满足预期
  内存使用: 合理
  CPU使用: 优化
```

#### 4.2 资源管理
```yaml
资源检查:
  - 内存泄露: 无
  - 文件句柄: 正确关闭
  - 数据库连接: 正确管理
  - 网络连接: 合理超时
```

---

### 5. 文档质量闸 (重要变更必须)
**触发时机**: 重要功能或架构变更
**检查范围**: 相关文档

#### 5.1 文档完整性
```yaml
文档要求:
  - API文档: 更新
  - 使用说明: 完整
  - 架构文档: 同步
  - 变更日志: 记录
```

#### 5.2 文档质量
```yaml
质量标准:
  - 准确性: 验证
  - 完整性: 检查
  - 易读性: 审查
  - 示例代码: 可执行
```

---

## 🔧 质量闸实施

### 自动化检查
```bash
# 预提交钩子 (.claude/hooks/pre-push-guard.sh)
质量闸检查流程:
1. Git状态检查
2. TypeScript/Python语法检查
3. 代码质量检查 (lint)
4. 安全扫描
5. 测试执行
6. 覆盖率检查
7. 构建验证
8. 文档同步检查
```

### 手动检查清单
```yaml
代码审查清单:
  架构设计:
    - [ ] 符合现有架构模式
    - [ ] 没有引入不必要复杂性
    - [ ] 接口设计合理

  代码质量:
    - [ ] 逻辑清晰易懂
    - [ ] 错误处理完善
    - [ ] 边缘情况考虑周全

  测试质量:
    - [ ] 测试用例充分
    - [ ] 覆盖关键路径
    - [ ] 模拟真实场景

  安全性:
    - [ ] 输入验证充分
    - [ ] 权限检查正确
    - [ ] 敏感数据保护
```

---

## ⚡ 质量闸配置

### 阈值设置
```yaml
# .claude/quality-thresholds.yml
测试覆盖率:
  最小值: 80%
  目标值: 90%

代码复杂度:
  最大圈复杂度: 10
  最大文件行数: 500
  最大函数行数: 50

性能基准:
  API响应时间: 100ms
  页面加载时间: 2s
  内存使用: <100MB
```

### 工具配置
```yaml
# 工具集成
TypeScript:
  配置: tsconfig.strict.json
  规则: @typescript-eslint/recommended

Python:
  类型检查: mypy --strict
  代码风格: black + flake8
  安全扫描: bandit

通用:
  Git钩子: pre-commit, pre-push
  CI/CD: GitHub Actions
  监控: 性能和错误监控
```

---

## 🚨 违规处理

### 质量闸失败处理
```yaml
失败等级:
  阻断性错误:
    - 编译失败
    - 测试失败
    - 安全高危漏洞
    处理: 立即阻止提交

  警告性错误:
    - 覆盖率不足
    - 代码质量问题
    - 文档不完整
    处理: 要求修复后提交

  建议性问题:
    - 性能可优化
    - 代码可重构
    处理: 记录并跟踪
```

### 例外处理机制
```yaml
紧急修复:
  条件: 生产环境严重问题
  流程: 先修复，后补充测试和文档
  要求: 24小时内补齐质量要求

技术债务:
  允许: 临时降低某些标准
  要求: 明确还债计划
  跟踪: 定期审查和清理
```

---

## 📊 质量度量

### 质量指标
```yaml
代码质量指标:
  - 测试覆盖率趋势
  - 代码重复率
  - 圈复杂度分布
  - 技术债务数量

流程质量指标:
  - 质量闸通过率
  - 缺陷逃逸率
  - 修复时间分布
  - 重复缺陷率
```

### 质量报告
```yaml
报告频率: 每周
报告内容:
  - 质量趋势分析
  - 问题热点识别
  - 改进建议
  - 工具效果评估
```

---

## 🔄 持续改进

### 质量闸演进
- **定期评估**: 每月审查质量闸效果
- **标准提升**: 逐步提高质量要求
- **工具升级**: 采用更好的检查工具
- **流程优化**: 减少误报，提高效率

### 反馈机制
- **开发者反馈**: 收集使用体验
- **自动化监控**: 跟踪质量趋势
- **定期审查**: 评估规则合理性
- **持续优化**: 基于数据调整标准

---

**宣言**: 质量是我们的承诺，质量闸是我们的守护者。每一次通过质量闸，都是对用户的一次承诺兑现。
