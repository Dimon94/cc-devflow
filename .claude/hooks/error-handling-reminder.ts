#!/usr/bin/env node

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é”™è¯¯å¤„ç†æœ€ä½³å®è·µæé†’ Hook (UserPromptSubmit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ã€æ ¸å¿ƒåŠŸèƒ½ã€‘
//   åœ¨ç”¨æˆ·æäº¤æ–° prompt å‰ï¼Œåˆ†ææœ¬ä¼šè¯ä¸­å·²ç¼–è¾‘çš„æ–‡ä»¶
//   å¦‚æœæ£€æµ‹åˆ°å¯èƒ½å­˜åœ¨é”™è¯¯å¤„ç†é£é™©çš„ä»£ç æ¨¡å¼ï¼Œæä¾›å®šåˆ¶åŒ–æé†’
//   å¸®åŠ©å¼€å‘è€…åœ¨ç¼–ç è¿‡ç¨‹ä¸­éµå¾ªé”™è¯¯å¤„ç†æœ€ä½³å®è·µ
//
// ã€å·¥ä½œåŸç†ã€‘
//   1. è¯»å–ä¼šè¯çº§åˆ«çš„æ–‡ä»¶ç¼–è¾‘è·Ÿè¸ªæ—¥å¿— (edited-files.log)
//   2. æ ¹æ®æ–‡ä»¶è·¯å¾„ï¼Œåˆ†ç±»ä¸º backend / frontend / database / other
//   3. å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œé™æ€ä»£ç åˆ†æï¼Œæ£€æµ‹å…³é”®æ¨¡å¼ï¼š
//      - async/await ä½¿ç”¨
//      - try/catch å­˜åœ¨æ€§
//      - Prisma æ•°æ®åº“æ“ä½œ
//      - Controller è·¯ç”±å®šä¹‰
//      - API è°ƒç”¨ï¼ˆfetch/axiosï¼‰
//   4. æ ¹æ®æ£€æµ‹ç»“æœï¼Œç”Ÿæˆåˆ†ç±»æé†’ï¼ˆBackend / Frontend / Databaseï¼‰
//   5. ä»…åœ¨æ£€æµ‹åˆ°é«˜é£é™©æ¨¡å¼æ—¶è¾“å‡ºæé†’ï¼Œé¿å…å™ªéŸ³
//
// ã€è®¾è®¡å“²å­¦ã€‘
//   - ä¸»åŠ¨æ•™è‚²ä¼˜äºè¢«åŠ¨ä¿®å¤ï¼šåœ¨é”™è¯¯äº§ç”Ÿå‰æé†’ï¼Œè€Œä¸æ˜¯äº‹åè¡¥æ•‘
//   - ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹å’Œä»£ç æ¨¡å¼ï¼Œæä¾›é’ˆå¯¹æ€§å»ºè®®
//   - ä½å™ªéŸ³åŸåˆ™ï¼šä»…åœ¨çœŸæ­£æœ‰é£é™©æ—¶æé†’ï¼Œé¿å…è¿‡åº¦æ‰“æ‰°
//   - å¯é€‰é€€å‡ºï¼šé€šè¿‡ç¯å¢ƒå˜é‡ SKIP_ERROR_REMINDER=1 å¯ç¦ç”¨
//
// ã€é€‚ç”¨åœºæ™¯ã€‘
//   - Backend å¼€å‘ï¼šç¡®ä¿æ‰€æœ‰å¼‚å¸¸éƒ½è¢« Sentry æ•è·
//   - Frontend å¼€å‘ï¼šç¡®ä¿ API é”™è¯¯æœ‰ç”¨æˆ·å‹å¥½çš„æç¤º
//   - Database æ“ä½œï¼šæé†’éªŒè¯å­—æ®µåå’Œè¿ç§»æµ‹è¯•
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç±»å‹å®šä¹‰ï¼šHook è¾“å…¥ä¸æ•°æ®ç»“æ„
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Hook è¾“å…¥æ•°æ®ç»“æ„ï¼ˆç”± Claude Code ä¼ é€’ï¼‰
 */
interface HookInput {
    session_id: string;         // ä¼šè¯å”¯ä¸€æ ‡è¯†ç¬¦
    transcript_path: string;    // å¯¹è¯å†å²æ–‡ä»¶è·¯å¾„
    cwd: string;                // å½“å‰å·¥ä½œç›®å½•
    permission_mode: string;    // æƒé™æ¨¡å¼ï¼ˆsandbox/dangerousï¼‰
    hook_event_name: string;    // Hook äº‹ä»¶åç§°
}

/**
 * æ–‡ä»¶ç¼–è¾‘è®°å½•ï¼ˆä» edited-files.log è§£æï¼‰
 */
interface EditedFile {
    path: string;       // æ–‡ä»¶ç»å¯¹è·¯å¾„
    tool: string;       // ä½¿ç”¨çš„å·¥å…·ï¼ˆWrite/Edit/MultiEditï¼‰
    timestamp: string;  // ç¼–è¾‘æ—¶é—´æˆ³
}

/**
 * ä¼šè¯çº§åˆ«çš„æ–‡ä»¶è·Ÿè¸ªæ•°æ®
 */
interface SessionTracking {
    edited_files: EditedFile[];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å‡½æ•°ï¼šæ ¹æ®æ–‡ä»¶è·¯å¾„åˆ¤æ–­æ–‡ä»¶åˆ†ç±»
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ã€åŠŸèƒ½è¯´æ˜ã€‘
//   é€šè¿‡è·¯å¾„ç‰¹å¾ï¼Œå°†æ–‡ä»¶åˆ†ç±»ä¸º backend / frontend / database / other
//   ç”¨äºåç»­æä¾›é’ˆå¯¹æ€§çš„é”™è¯¯å¤„ç†å»ºè®®
//
// ã€åˆ†ç±»è§„åˆ™ã€‘
//   - Frontend: åŒ…å« /frontend/, /client/, /src/components/, /src/features/
//   - Backend:  åŒ…å« /src/controllers/, /src/services/, /src/routes/, /src/api/, /server/
//   - Database: åŒ…å« /database/, /prisma/, /migrations/
//   - Other:    ä»¥ä¸Šéƒ½ä¸åŒ¹é…çš„æ–‡ä»¶
//
// ã€ä¸ºä»€ä¹ˆåŸºäºè·¯å¾„è€Œä¸æ˜¯æ‰©å±•åã€‘
//   - æ‰©å±•åä¸è¶³ä»¥åŒºåˆ†å‰åç«¯ï¼ˆéƒ½å¯èƒ½æ˜¯ .ts/.tsxï¼‰
//   - è·¯å¾„ç»“æ„åæ˜ äº†é¡¹ç›®æ¶æ„ï¼Œæ›´å‡†ç¡®
//   - ä¾¿äºé€‚é…ä¸åŒé¡¹ç›®ç»“æ„ï¼ˆå¯è½»æ¾æ‰©å±•è§„åˆ™ï¼‰
//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFileCategory(filePath: string): 'backend' | 'frontend' | 'database' | 'other' {
    // â”€â”€â”€ Frontend æ£€æµ‹ â”€â”€â”€
    if (filePath.includes('/frontend/') ||
        filePath.includes('/client/') ||
        filePath.includes('/src/components/') ||
        filePath.includes('/src/features/')) return 'frontend';

    // â”€â”€â”€ Backend æ£€æµ‹ï¼ˆå¸¸è§æœåŠ¡ç›®å½•ï¼‰â”€â”€â”€
    if (filePath.includes('/src/controllers/') ||
        filePath.includes('/src/services/') ||
        filePath.includes('/src/routes/') ||
        filePath.includes('/src/api/') ||
        filePath.includes('/server/')) return 'backend';

    // â”€â”€â”€ Database æ£€æµ‹ â”€â”€â”€
    if (filePath.includes('/database/') ||
        filePath.includes('/prisma/') ||
        filePath.includes('/migrations/')) return 'database';

    // â”€â”€â”€ å…œåº•åˆ†ç±» â”€â”€â”€
    return 'other';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å‡½æ•°ï¼šåˆ¤æ–­æ–‡ä»¶æ˜¯å¦éœ€è¦é”™è¯¯å¤„ç†æ£€æŸ¥
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ã€åŠŸèƒ½è¯´æ˜ã€‘
//   è¿‡æ»¤ä¸éœ€è¦é”™è¯¯å¤„ç†æ£€æŸ¥çš„æ–‡ä»¶ç±»å‹ï¼Œå‡å°‘è¯¯æŠ¥
//
// ã€æ’é™¤è§„åˆ™ã€‘
//   - æµ‹è¯•æ–‡ä»¶ï¼ˆ.test.ts, .spec.tsxï¼‰ï¼šæµ‹è¯•ä»£ç æœ‰è‡ªå·±çš„é”™è¯¯å¤„ç†æ¨¡å¼
//   - é…ç½®æ–‡ä»¶ï¼ˆ.config.tsï¼‰ï¼šé…ç½®é€šå¸¸æ˜¯é™æ€çš„ï¼Œä¸æ¶‰åŠè¿è¡Œæ—¶é”™è¯¯
//   - ç±»å‹å®šä¹‰æ–‡ä»¶ï¼ˆ.d.tsï¼‰ï¼šçº¯ç±»å‹å£°æ˜ï¼Œæ— è¿è¡Œæ—¶ä»£ç 
//   - ç±»å‹ç›®å½•ï¼ˆ/types/ï¼‰ï¼šåŒä¸Š
//   - æ ·å¼æ–‡ä»¶ï¼ˆ.styles.tsï¼‰ï¼šCSS-in-JSï¼Œé€šå¸¸ä¸æ¶‰åŠå¼‚æ­¥æ“ä½œ
//
// ã€åŒ…å«è§„åˆ™ã€‘
//   - æ‰€æœ‰ .ts/.tsx/.js/.jsx æ–‡ä»¶ï¼ˆæ’é™¤ä¸Šè¿°æƒ…å†µï¼‰
//
// ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€‘
//   - é¿å…å™ªéŸ³ï¼šæµ‹è¯•å’Œé…ç½®æ–‡ä»¶ä¸åº”è§¦å‘ä¸šåŠ¡ä»£ç çš„é”™è¯¯å¤„ç†æé†’
//   - æé«˜ä¿¡å™ªæ¯”ï¼šä¸“æ³¨äºçœŸæ­£éœ€è¦å…³æ³¨çš„ä¸šåŠ¡é€»è¾‘ä»£ç 
//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shouldCheckErrorHandling(filePath: string): boolean {
    // â”€â”€â”€ æ’é™¤æµ‹è¯•æ–‡ä»¶ â”€â”€â”€
    if (filePath.match(/\.(test|spec)\.(ts|tsx)$/)) return false;

    // â”€â”€â”€ æ’é™¤é…ç½®æ–‡ä»¶å’Œç±»å‹å®šä¹‰ â”€â”€â”€
    if (filePath.match(/\.(config|d)\.(ts|tsx)$/)) return false;

    // â”€â”€â”€ æ’é™¤ç±»å‹ç›®å½• â”€â”€â”€
    if (filePath.includes('types/')) return false;

    // â”€â”€â”€ æ’é™¤æ ·å¼æ–‡ä»¶ â”€â”€â”€
    if (filePath.includes('.styles.ts')) return false;

    // â”€â”€â”€ ä»…æ£€æŸ¥ä»£ç æ–‡ä»¶ â”€â”€â”€
    return filePath.match(/\.(ts|tsx|js|jsx)$/) !== null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å‡½æ•°ï¼šé™æ€ä»£ç åˆ†æ - æ£€æµ‹é”™è¯¯å¤„ç†ç›¸å…³æ¨¡å¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ã€åŠŸèƒ½è¯´æ˜ã€‘
//   è¯»å–æ–‡ä»¶å†…å®¹ï¼Œé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹å…³é”®ä»£ç æ¨¡å¼
//   ç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦åŒ…å«éœ€è¦ç‰¹åˆ«å…³æ³¨é”™è¯¯å¤„ç†çš„ä»£ç 
//
// ã€æ£€æµ‹æ¨¡å¼ã€‘
//   1. hasTryCatch   - æ˜¯å¦ä½¿ç”¨ try-catch å—
//   2. hasAsync      - æ˜¯å¦ä½¿ç”¨ async å‡½æ•°
//   3. hasPrisma     - æ˜¯å¦åŒ…å« Prisma ORM æ“ä½œ
//   4. hasController - æ˜¯å¦å®šä¹‰ HTTP è·¯ç”±/æ§åˆ¶å™¨
//   5. hasApiCall    - æ˜¯å¦è°ƒç”¨å¤–éƒ¨ APIï¼ˆfetch/axiosï¼‰
//
// ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ­£åˆ™è€Œä¸æ˜¯ ASTã€‘
//   - è½»é‡çº§ï¼šæ— éœ€è§£æå®Œæ•´è¯­æ³•æ ‘ï¼Œæ€§èƒ½æ›´å¥½
//   - è¶³å¤Ÿå‡†ç¡®ï¼šå¯¹äºæé†’åœºæ™¯ï¼Œæ­£åˆ™åŒ¹é…è¶³å¤Ÿè¯†åˆ«é£é™©
//   - ä½ä¾èµ–ï¼šä¸éœ€è¦å¼•å…¥ TypeScript ç¼–è¯‘å™¨æˆ– Babel
//   - å¿«é€Ÿæ‰§è¡Œï¼šHook éœ€è¦å°½å¯èƒ½å¿«ï¼Œé¿å…é˜»å¡ç”¨æˆ·
//
// ã€è®¾è®¡æƒè¡¡ã€‘
//   - å¯èƒ½å­˜åœ¨è¯¯æŠ¥ï¼ˆå¦‚æ³¨é‡Šä¸­çš„ä»£ç ï¼‰ï¼Œä½†å¯¹æé†’åœºæ™¯å¯æ¥å—
//   - ä¸æ”¯æŒå¤æ‚çš„ä»£ç æ··æ·†ï¼Œä½†ç›®æ ‡æ˜¯æºç åˆ†æ
//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyzeFileContent(filePath: string): {
    hasTryCatch: boolean;
    hasAsync: boolean;
    hasPrisma: boolean;
    hasController: boolean;
    hasApiCall: boolean;
} {
    // â”€â”€â”€ æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ â”€â”€â”€
    if (!existsSync(filePath)) {
        // æ–‡ä»¶å·²è¢«åˆ é™¤æˆ–è·¯å¾„é”™è¯¯ï¼Œè¿”å›ç©ºç»“æœ
        return { hasTryCatch: false, hasAsync: false, hasPrisma: false, hasController: false, hasApiCall: false };
    }

    // â”€â”€â”€ è¯»å–æ–‡ä»¶å†…å®¹ â”€â”€â”€
    const content = readFileSync(filePath, 'utf-8');

    // â”€â”€â”€ æ¨¡å¼æ£€æµ‹ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰â”€â”€â”€
    return {
        // Try-catch å—æ£€æµ‹ï¼šåŒ¹é… "try {" æ¨¡å¼
        hasTryCatch: /try\s*\{/.test(content),

        // Async å‡½æ•°æ£€æµ‹ï¼šåŒ¹é… "async " å…³é”®å­—
        hasAsync: /async\s+/.test(content),

        // Prisma æ“ä½œæ£€æµ‹ï¼šåŒ¹é…å¸¸è§ Prisma API è°ƒç”¨
        // ç¤ºä¾‹ï¼šprisma.user.findMany(), PrismaService, create(), update()
        hasPrisma: /prisma\.|PrismaService|findMany|findUnique|create\(|update\(|delete\(/i.test(content),

        // Controller æ£€æµ‹ï¼šåŒ¹é…è·¯ç”±å®šä¹‰æˆ–æ§åˆ¶å™¨ç±»
        // ç¤ºä¾‹ï¼šexport class UserController, router.get(), app.post()
        hasController: /export class.*Controller|router\.|app\.(get|post|put|delete|patch)/.test(content),

        // API è°ƒç”¨æ£€æµ‹ï¼šåŒ¹é…å¸¸è§ HTTP å®¢æˆ·ç«¯
        // ç¤ºä¾‹ï¼šfetch(), axios.get(), apiClient.post()
        hasApiCall: /fetch\(|axios\.|apiClient\./i.test(content),
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸»æµç¨‹ï¼šåˆ†æä¼šè¯æ–‡ä»¶å¹¶ç”Ÿæˆé”™è¯¯å¤„ç†æé†’
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function main() {
    try {
        // â”€â”€â”€ Step 1: è¯»å– Hook è¾“å…¥æ•°æ® â”€â”€â”€
        const input = readFileSync(0, 'utf-8'); // ä» stdin è¯»å–
        const data: HookInput = JSON.parse(input);

        const { session_id } = data;
        const projectDir = process.env.CLAUDE_PROJECT_DIR || process.cwd();

        // â”€â”€â”€ Step 2: æ£€æŸ¥æ–‡ä»¶ç¼–è¾‘è·Ÿè¸ªæ—¥å¿— â”€â”€â”€
        //
        // ã€æ—¥å¿—ä½ç½®ã€‘
        //   $CLAUDE_PROJECT_DIR/.claude/tsc-cache/{session_id}/edited-files.log
        //
        // ã€ä¸ºä»€ä¹ˆéœ€è¦è·Ÿè¸ªæ—¥å¿—ã€‘
        //   - ä¼šè¯çº§åˆ«çŠ¶æ€ï¼šHook æ˜¯æ— çŠ¶æ€çš„ï¼Œéœ€è¦å¤–éƒ¨å­˜å‚¨æ¥è·Ÿè¸ªä¼šè¯ä¸­çš„æ–‡ä»¶ç¼–è¾‘
        //   - å¢é‡åˆ†æï¼šä»…åˆ†ææœ¬ä¼šè¯ä¸­ç¼–è¾‘è¿‡çš„æ–‡ä»¶ï¼Œé¿å…å…¨é‡æ‰«æ
        //
        // ã€è·¯å¾„ç»Ÿä¸€ã€‘
        //   ä¸ post-tool-use-tracker.sh ä½¿ç”¨ç›¸åŒçš„é¡¹ç›®çº§åˆ«ç¼“å­˜è·¯å¾„
        //
        const cacheDir = join(projectDir, '.claude', 'tsc-cache', session_id);
        const trackingFile = join(cacheDir, 'edited-files.log');

        // å¦‚æœæ²¡æœ‰ç¼–è¾‘è®°å½•ï¼Œç›´æ¥é€€å‡ºï¼ˆæ— éœ€æé†’ï¼‰
        if (!existsSync(trackingFile)) {
            process.exit(0);
        }

        // â”€â”€â”€ Step 3: è§£æç¼–è¾‘è®°å½• â”€â”€â”€
        //
        // ã€æ–‡ä»¶æ ¼å¼ã€‘
        //   æ¯è¡Œæ ¼å¼ï¼š{timestamp}\t{tool}\t{file_path}
        //   ç¤ºä¾‹ï¼š2025-01-15T10:30:00Z	Write	/path/to/file.ts
        //
        const trackingContent = readFileSync(trackingFile, 'utf-8');
        const editedFiles = trackingContent
            .trim()
            .split('\n')
            .filter(line => line.length > 0)
            .map(line => {
                const [timestamp, tool, path] = line.split('\t');
                return { timestamp, tool, path };
            });

        // å¦‚æœè§£æç»“æœä¸ºç©ºï¼Œé€€å‡º
        if (editedFiles.length === 0) {
            process.exit(0);
        }

        // â”€â”€â”€ Step 4: æ–‡ä»¶åˆ†ç±»ä¸ä»£ç åˆ†æ â”€â”€â”€
        //
        // ã€åˆ†ç±»ç›®çš„ã€‘
        //   - æŒ‰ç…§æ–‡ä»¶ç±»å‹ï¼ˆbackend/frontend/databaseï¼‰åˆ†ç»„
        //   - ä¸ºåç»­æä¾›é’ˆå¯¹æ€§çš„é”™è¯¯å¤„ç†å»ºè®®
        //
        const categories = {
            backend: [] as string[],
            frontend: [] as string[],
            database: [] as string[],
            other: [] as string[],
        };

        // å­˜å‚¨æ¯ä¸ªæ–‡ä»¶çš„åˆ†æç»“æœ
        const analysisResults: Array<{
            path: string;
            category: string;
            analysis: ReturnType<typeof analyzeFileContent>;
        }> = [];

        // â”€â”€â”€ éå†æ‰€æœ‰ç¼–è¾‘è¿‡çš„æ–‡ä»¶ â”€â”€â”€
        for (const file of editedFiles) {
            // è¿‡æ»¤ä¸éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶ï¼ˆæµ‹è¯•ã€é…ç½®ç­‰ï¼‰
            if (!shouldCheckErrorHandling(file.path)) continue;

            // åˆ†ç±»æ–‡ä»¶
            const category = getFileCategory(file.path);
            categories[category].push(file.path);

            // åˆ†ææ–‡ä»¶å†…å®¹
            const analysis = analyzeFileContent(file.path);
            analysisResults.push({ path: file.path, category, analysis });
        }

        // â”€â”€â”€ Step 5: é£é™©è¯„ä¼° â”€â”€â”€
        //
        // ã€ä½•æ—¶éœ€è¦æé†’ã€‘
        //   å¦‚æœä»»ä½•æ–‡ä»¶åŒ…å«ä»¥ä¸‹æ¨¡å¼ä¹‹ä¸€ï¼Œåˆ™éœ€è¦æé†’ï¼š
        //   - try-catch å— â†’ å¯èƒ½éœ€è¦ Sentry æ•è·
        //   - async å‡½æ•° â†’ å¯èƒ½æœ‰æœªå¤„ç†çš„ Promise rejection
        //   - Prisma æ“ä½œ â†’ æ•°æ®åº“é”™è¯¯éœ€è¦å¦¥å–„å¤„ç†
        //   - Controller å®šä¹‰ â†’ HTTP é”™è¯¯éœ€è¦ç»Ÿä¸€å¤„ç†
        //   - API è°ƒç”¨ â†’ ç½‘ç»œé”™è¯¯éœ€è¦ç”¨æˆ·æç¤º
        //
        const needsAttention = analysisResults.some(
            ({ analysis }) =>
                analysis.hasTryCatch ||
                analysis.hasAsync ||
                analysis.hasPrisma ||
                analysis.hasController ||
                analysis.hasApiCall
        );

        // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°é£é™©æ¨¡å¼ï¼Œé™é»˜é€€å‡ºï¼ˆé¿å…å™ªéŸ³ï¼‰
        if (!needsAttention) {
            process.exit(0);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Step 6: ç”Ÿæˆåˆ†ç±»æé†’
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â”€â”€â”€ æé†’æ ‡é¢˜ â”€â”€â”€
        console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“‹ ERROR HANDLING SELF-CHECK');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Backend æé†’ï¼šSentry é›†æˆä¸é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ã€æé†’è§¦å‘æ¡ä»¶ã€‘
        //   - ç¼–è¾‘äº† backend åˆ†ç±»çš„æ–‡ä»¶
        //   - æ£€æµ‹åˆ° try-catch / Prisma / Controller ç­‰æ¨¡å¼
        //
        // ã€æé†’å†…å®¹ã€‘
        //   - è¯¢é—®æ˜¯å¦æ·»åŠ  Sentry.captureException()
        //   - è¯¢é—® Prisma æ“ä½œæ˜¯å¦æœ‰é”™è¯¯å¤„ç†
        //   - è¯¢é—® Controller æ˜¯å¦ä½¿ç”¨ BaseController.handleError()
        //   - æä¾›æœ€ä½³å®è·µå»ºè®®
        //
        if (categories.backend.length > 0) {
            const backendFiles = analysisResults.filter(f => f.category === 'backend');

            // èšåˆæ£€æµ‹ç»“æœ
            const hasTryCatch = backendFiles.some(f => f.analysis.hasTryCatch);
            const hasPrisma = backendFiles.some(f => f.analysis.hasPrisma);
            const hasController = backendFiles.some(f => f.analysis.hasController);

            console.log('âš ï¸  Backend Changes Detected');
            console.log(`   ${categories.backend.length} file(s) edited\n`);

            // â”€â”€â”€ æ¡ä»¶åŒ–æé†’ï¼šä»…æ˜¾ç¤ºç›¸å…³é—®é¢˜ â”€â”€â”€
            if (hasTryCatch) {
                console.log('   â“ Did you add Sentry.captureException() in catch blocks?');
            }
            if (hasPrisma) {
                console.log('   â“ Are Prisma operations wrapped in error handling?');
            }
            if (hasController) {
                console.log('   â“ Do controllers use BaseController.handleError()?');
            }

            // â”€â”€â”€ æœ€ä½³å®è·µå»ºè®® â”€â”€â”€
            console.log('\n   ğŸ’¡ Backend Best Practice:');
            console.log('      - All errors should be captured to Sentry');
            console.log('      - Use appropriate error helpers for context');
            console.log('      - Controllers should extend BaseController\n');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Frontend æé†’ï¼šç”¨æˆ·ä½“éªŒä¸é”™è¯¯åé¦ˆ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ã€æé†’è§¦å‘æ¡ä»¶ã€‘
        //   - ç¼–è¾‘äº† frontend åˆ†ç±»çš„æ–‡ä»¶
        //   - æ£€æµ‹åˆ° API è°ƒç”¨æˆ– try-catch å—
        //
        // ã€æé†’å†…å®¹ã€‘
        //   - è¯¢é—® API é”™è¯¯æ˜¯å¦æœ‰ç”¨æˆ·å‹å¥½çš„æç¤º
        //   - è¯¢é—®é”™è¯¯æ˜¯å¦å±•ç¤ºç»™ç”¨æˆ·
        //   - æä¾›å‰ç«¯é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
        //
        if (categories.frontend.length > 0) {
            const frontendFiles = analysisResults.filter(f => f.category === 'frontend');

            // èšåˆæ£€æµ‹ç»“æœ
            const hasApiCall = frontendFiles.some(f => f.analysis.hasApiCall);
            const hasTryCatch = frontendFiles.some(f => f.analysis.hasTryCatch);

            console.log('ğŸ’¡ Frontend Changes Detected');
            console.log(`   ${categories.frontend.length} file(s) edited\n`);

            // â”€â”€â”€ æ¡ä»¶åŒ–æé†’ â”€â”€â”€
            if (hasApiCall) {
                console.log('   â“ Do API calls show user-friendly error messages?');
            }
            if (hasTryCatch) {
                console.log('   â“ Are errors displayed to the user?');
            }

            // â”€â”€â”€ æœ€ä½³å®è·µå»ºè®® â”€â”€â”€
            console.log('\n   ğŸ’¡ Frontend Best Practice:');
            console.log('      - Use your notification system for user feedback');
            console.log('      - Error boundaries for component errors');
            console.log('      - Display user-friendly error messages\n');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Database æé†’ï¼šSchema ä¸€è‡´æ€§ä¸è¿ç§»æµ‹è¯•
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ã€æé†’è§¦å‘æ¡ä»¶ã€‘
        //   - ç¼–è¾‘äº† database åˆ†ç±»çš„æ–‡ä»¶ï¼ˆå¦‚ Prisma schema, migrationsï¼‰
        //
        // ã€æé†’å†…å®¹ã€‘
        //   - è¯¢é—®åˆ—åæ˜¯å¦ä¸ schema ä¸€è‡´
        //   - è¯¢é—®è¿ç§»æ˜¯å¦ç»è¿‡æµ‹è¯•
        //
        if (categories.database.length > 0) {
            console.log('ğŸ—„ï¸  Database Changes Detected');
            console.log(`   ${categories.database.length} file(s) edited\n`);
            console.log('   â“ Did you verify column names against schema?');
            console.log('   â“ Are migrations tested?\n');
        }

        // â”€â”€â”€ æé†’å°¾éƒ¨ï¼šç¦ç”¨æç¤º â”€â”€â”€
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ’¡ TIP: Disable with SKIP_ERROR_REMINDER=1');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

        // æ­£å¸¸é€€å‡ºï¼ˆæé†’ä¸åº”é˜»å¡ç”¨æˆ·ï¼‰
        process.exit(0);

    } catch (err) {
        // â”€â”€â”€ é™é»˜å¤±è´¥ç­–ç•¥ â”€â”€â”€
        //
        // ã€ä¸ºä»€ä¹ˆé™é»˜å¤±è´¥ã€‘
        //   - æé†’æ˜¯è¾…åŠ©åŠŸèƒ½ï¼Œä¸åº”å›  Hook é”™è¯¯è€Œä¸­æ–­ç”¨æˆ·å·¥ä½œæµ
        //   - é¿å…ç»™ç”¨æˆ·å¸¦æ¥å›°æ‰°ï¼ˆå¦‚è§£æé”™è¯¯ã€æ–‡ä»¶ä¸å­˜åœ¨ç­‰ï¼‰
        //   - ä¿è¯ Claude Code çš„æ ¸å¿ƒåŠŸèƒ½ä¸å—å½±å“
        //
        process.exit(0);
    }
}

// â”€â”€â”€ å…¥å£æ‰§è¡Œ â”€â”€â”€
// æ•è·æœªå¤„ç†çš„ Promise rejectionï¼Œç¡®ä¿ Hook ä¸ä¼šå´©æºƒ
main().catch(() => process.exit(0));
