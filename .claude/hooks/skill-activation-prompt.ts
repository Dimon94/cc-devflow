#!/usr/bin/env node

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æŠ€èƒ½è‡ªåŠ¨æ¿€æ´» Hook - TypeScript å®ç°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ã€æ ¸å¿ƒåŠŸèƒ½ã€‘
// åœ¨ç”¨æˆ·æ¯æ¬¡æäº¤ prompt æ—¶è‡ªåŠ¨åˆ†æå¹¶å»ºè®®ç›¸å…³æŠ€èƒ½
//
// ã€å·¥ä½œåŸç†ã€‘
// 1. è¯»å–ç”¨æˆ·è¾“å…¥çš„ prompt
// 2. åŠ è½½ skill-rules.json é…ç½®æ–‡ä»¶
// 3. æ ¹æ®å…³é”®è¯å’Œæ„å›¾æ¨¡å¼åŒ¹é…æŠ€èƒ½
// 4. æŒ‰ä¼˜å…ˆçº§åˆ†ç»„å¹¶è¾“å‡ºå»ºè®®
//
// ã€è®¾è®¡å“²å­¦ã€‘
// "å·¥å…·åº”è¯¥é€‚åº”äººçš„æ€ç»´ï¼Œè€Œä¸æ˜¯è®©äººé€‚åº”å·¥å…·"
// æŠ€èƒ½åœ¨ä½ éœ€è¦æ—¶æ¿€æ´»ï¼Œè€Œä¸æ˜¯åœ¨ä½ è®°å¾—æ—¶æ¿€æ´»
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import { readFileSync } from 'fs';
import { join } from 'path';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç±»å‹å®šä¹‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Hook è¾“å…¥æ¥å£
 * Claude Code ä¼ é€’ç»™ UserPromptSubmit hook çš„æ•°æ®ç»“æ„
 */
interface HookInput {
    session_id: string;        // ä¼šè¯ ID
    transcript_path: string;   // å¯¹è¯è®°å½•è·¯å¾„
    cwd: string;               // å½“å‰å·¥ä½œç›®å½•
    permission_mode: string;   // æƒé™æ¨¡å¼
    prompt: string;            // ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
}

/**
 * æç¤ºè§¦å‘å™¨é…ç½®
 * å®šä¹‰å¦‚ä½•é€šè¿‡ç”¨æˆ·è¾“å…¥è§¦å‘æŠ€èƒ½
 */
interface PromptTriggers {
    keywords?: string[];        // å…³é”®è¯åˆ—è¡¨ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    intentPatterns?: string[];  // æ„å›¾æ¨¡å¼åˆ—è¡¨ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
}

/**
 * æŠ€èƒ½è§„åˆ™é…ç½®
 * å®šä¹‰å•ä¸ªæŠ€èƒ½çš„æ¿€æ´»æ¡ä»¶å’Œä¼˜å…ˆçº§
 */
interface SkillRule {
    type: 'guardrail' | 'domain';                    // æŠ€èƒ½ç±»å‹ï¼šæŠ¤æ  | é¢†åŸŸ
    enforcement: 'block' | 'suggest' | 'warn';       // å¼ºåˆ¶çº§åˆ«ï¼šé˜»å¡ | å»ºè®® | è­¦å‘Š
    priority: 'critical' | 'high' | 'medium' | 'low'; // ä¼˜å…ˆçº§
    promptTriggers?: PromptTriggers;                  // æç¤ºè§¦å‘å™¨
}

/**
 * æŠ€èƒ½è§„åˆ™é›†åˆ
 * skill-rules.json çš„æ ¹æ•°æ®ç»“æ„
 */
interface SkillRules {
    version: string;                    // è§„åˆ™ç‰ˆæœ¬
    skills: Record<string, SkillRule>;  // æŠ€èƒ½åç§° -> è§„åˆ™é…ç½®
}

/**
 * åŒ¹é…åˆ°çš„æŠ€èƒ½
 * å†…éƒ¨ä½¿ç”¨ï¼Œè®°å½•åŒ¹é…ç»“æœ
 */
interface MatchedSkill {
    name: string;                          // æŠ€èƒ½åç§°
    matchType: 'keyword' | 'intent';       // åŒ¹é…ç±»å‹ï¼šå…³é”®è¯ | æ„å›¾
    config: SkillRule;                     // æŠ€èƒ½é…ç½®
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ä¸»å‡½æ•°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function main() {
    try {
        // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        // â”‚ æ­¥éª¤ 1: è¯»å–è¾“å…¥                                                      â”‚
        // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        // ä» stdin è¯»å– Claude Code ä¼ é€’çš„ JSON æ•°æ®
        const input = readFileSync(0, 'utf-8');
        const data: HookInput = JSON.parse(input);
        const prompt = data.prompt.toLowerCase(); // è½¬å°å†™ä¾¿äºåŒ¹é…

        // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        // â”‚ æ­¥éª¤ 2: åŠ è½½æŠ€èƒ½è§„åˆ™é…ç½®                                              â”‚
        // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        const projectDir = process.env.CLAUDE_PROJECT_DIR || process.cwd();
        const rulesPath = join(projectDir, '.claude', 'skills', 'skill-rules.json');
        const rules: SkillRules = JSON.parse(readFileSync(rulesPath, 'utf-8'));

        // å­˜å‚¨åŒ¹é…åˆ°çš„æŠ€èƒ½
        const matchedSkills: MatchedSkill[] = [];

        // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        // â”‚ æ­¥éª¤ 3: éå†æ‰€æœ‰æŠ€èƒ½ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…                                     â”‚
        // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        for (const [skillName, config] of Object.entries(rules.skills)) {
            const triggers = config.promptTriggers;

            // å¦‚æœæ²¡æœ‰é…ç½®è§¦å‘å™¨ï¼Œè·³è¿‡æ­¤æŠ€èƒ½
            if (!triggers) {
                continue;
            }

            // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            // â”‚ 3.1 å…³é”®è¯åŒ¹é…                                                 â”‚
            // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            // æ£€æŸ¥ prompt ä¸­æ˜¯å¦åŒ…å«é…ç½®çš„å…³é”®è¯
            if (triggers.keywords) {
                const keywordMatch = triggers.keywords.some(kw =>
                    prompt.includes(kw.toLowerCase())
                );
                if (keywordMatch) {
                    matchedSkills.push({ name: skillName, matchType: 'keyword', config });
                    continue; // åŒ¹é…åˆ°å°±ç»§ç»­ä¸‹ä¸€ä¸ªæŠ€èƒ½
                }
            }

            // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            // â”‚ 3.2 æ„å›¾æ¨¡å¼åŒ¹é…                                               â”‚
            // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ›´å¤æ‚çš„æ„å›¾æ¨¡å¼
            if (triggers.intentPatterns) {
                const intentMatch = triggers.intentPatterns.some(pattern => {
                    const regex = new RegExp(pattern, 'i'); // 'i' = å¿½ç•¥å¤§å°å†™
                    return regex.test(prompt);
                });
                if (intentMatch) {
                    matchedSkills.push({ name: skillName, matchType: 'intent', config });
                }
            }
        }

        // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        // â”‚ æ­¥éª¤ 4: ç”Ÿæˆè¾“å‡ºï¼ˆå¦‚æœæœ‰åŒ¹é…ï¼‰                                         â”‚
        // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        if (matchedSkills.length > 0) {
            let output = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            output += 'ğŸ¯ SKILL ACTIVATION CHECK\n';
            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

            // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            // â”‚ 4.1 æŒ‰ä¼˜å…ˆçº§åˆ†ç»„                                               â”‚
            // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            const critical = matchedSkills.filter(s => s.config.priority === 'critical');
            const high = matchedSkills.filter(s => s.config.priority === 'high');
            const medium = matchedSkills.filter(s => s.config.priority === 'medium');
            const low = matchedSkills.filter(s => s.config.priority === 'low');

            // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            // â”‚ 4.2 è¾“å‡ºå„ä¼˜å…ˆçº§çš„æŠ€èƒ½                                         â”‚
            // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            // å…³é”®æŠ€èƒ½ï¼ˆå¿…éœ€ï¼‰
            if (critical.length > 0) {
                output += 'âš ï¸ CRITICAL SKILLS (REQUIRED):\n';
                critical.forEach(s => output += `  â†’ ${s.name}\n`);
                output += '\n';
            }

            // æ¨èæŠ€èƒ½
            if (high.length > 0) {
                output += 'ğŸ“š RECOMMENDED SKILLS:\n';
                high.forEach(s => output += `  â†’ ${s.name}\n`);
                output += '\n';
            }

            // å»ºè®®æŠ€èƒ½
            if (medium.length > 0) {
                output += 'ğŸ’¡ SUGGESTED SKILLS:\n';
                medium.forEach(s => output += `  â†’ ${s.name}\n`);
                output += '\n';
            }

            // å¯é€‰æŠ€èƒ½
            if (low.length > 0) {
                output += 'ğŸ“Œ OPTIONAL SKILLS:\n';
                low.forEach(s => output += `  â†’ ${s.name}\n`);
                output += '\n';
            }

            // æ“ä½œæç¤º
            output += 'ACTION: Use Skill tool BEFORE responding\n';
            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

            // è¾“å‡ºåˆ° stdoutï¼ˆClaude Code ä¼šæ•è·å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
            console.log(output);
        }

        process.exit(0); // æˆåŠŸé€€å‡º
    } catch (err) {
        // é”™è¯¯å¤„ç†ï¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ° stderr
        console.error('Error in skill-activation-prompt hook:', err);
        process.exit(1); // é”™è¯¯é€€å‡º
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¨‹åºå…¥å£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main().catch(err => {
    console.error('Uncaught error:', err);
    process.exit(1);
});
